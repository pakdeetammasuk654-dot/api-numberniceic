<div class="card">
    <form id="analysisForm" action="/analysis" method="POST">

        <div class="analysis-form" style="display: flex; gap: 10px; flex-wrap: wrap;">

            <div class="group-name" style="position: relative; flex: 2; min-width: 200px; margin: 0;">
                <input type="text" id="nameInput" name="name" class="form-control"
                       placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)" required
                       maxlength="24"
                       value="{{if .Name}}{{.Name}}{{else}}‡∏≠‡∏ì‡∏±‡∏ç‡∏ç‡∏≤{{end}}"
                       style="width: 100%; padding-right: 40px; margin: 0;">

                <button type="button" id="clearInputBtn"
                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
                               border: none; background: none; color: #aaa; font-size: 1.2rem;
                               cursor: pointer; padding: 0; line-height: 1; display: none;">
                    &times;
                </button>
            </div>

            <div class="group-birth" style="position: relative; flex: 1; min-width: 150px; margin: 0;">
                <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 1.2rem; pointer-events: none;">
                    üìÖ
                </span>

                <select id="birthInput" name="birth_day" class="form-control"
                        style="width: 100%; padding-left: 45px; margin: 0; cursor: pointer;"
                        required onchange="this.form.submit()">
                    <option value="" disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î --</option>
                    <option value="sunday" {{if or (eq .BirthDay "sunday") (not .BirthDay)}}selected{{end}}>‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</option>
                    <option value="monday" {{if eq .BirthDay "monday"}}selected{{end}}>‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option>
                    <option value="tuesday" {{if eq .BirthDay "tuesday"}}selected{{end}}>‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</option>
                    <option value="wednesday1" {{if eq .BirthDay "wednesday1"}}selected{{end}}>‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò (‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô)</option>
                    <option value="wednesday2" {{if eq .BirthDay "wednesday2"}}selected{{end}}>‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò (‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô)</option>
                    <option value="thursday" {{if eq .BirthDay "thursday"}}selected{{end}}>‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</option>
                    <option value="friday" {{if eq .BirthDay "friday"}}selected{{end}}>‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå</option>
                    <option value="saturday" {{if eq .BirthDay "saturday"}}selected{{end}}>‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå</option>
                </select>
            </div>
        </div>
    </form>

    <div class="sample-section">
        <p class="sample-title" style="text-align: center; margin-top: 0;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î ‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á</p>

        <div class="sample-grid">
            <div class="sample-item" data-name="‡∏°‡∏µ‡∏ô‡∏≤">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Meena" alt="Meena">
                <span>‡∏°‡∏µ‡∏ô‡∏≤</span>
            </div>
            <div class="sample-item" data-name="‡∏≠‡∏≤‡∏£‡∏µ">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Aree" alt="Aree">
                <span>‡∏≠‡∏≤‡∏£‡∏µ</span>
            </div>
            <div class="sample-item" data-name="‡∏®‡∏¥‡∏•‡∏≤">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Sila" alt="Sila">
                <span>‡∏®‡∏¥‡∏•‡∏≤</span>
            </div>
            <div class="sample-item" data-name="‡∏ß‡∏≤‡∏£‡∏µ">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Waree" alt="Waree">
                <span>‡∏ß‡∏≤‡∏£‡∏µ</span>
            </div>
            <div class="sample-item" data-name="‡∏ô‡∏≤‡∏£‡∏≤">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Nara" alt="Nara">
                <span>‡∏ô‡∏≤‡∏£‡∏≤</span>
            </div>
            <div class="sample-item" data-name="‡∏ò‡∏≤‡∏£‡∏≤">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Thara" alt="Thara">
                <span>‡∏ò‡∏≤‡∏£‡∏≤</span>
            </div>
            <div class="sample-item" data-name="‡∏†‡∏π‡∏ú‡∏≤">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Phupha" alt="Phupha">
                <span>‡∏†‡∏π‡∏ú‡∏≤</span>
            </div>
            <div class="sample-item" data-name="‡∏ô‡∏≤‡∏ß‡∏≤">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Nawa" alt="Nawa">
                <span>‡∏ô‡∏≤‡∏ß‡∏≤</span>
            </div>
            <div class="sample-item" data-name="‡∏ó‡∏¥‡∏ß‡∏≤">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Tiwa" alt="Tiwa">
                <span>‡∏ó‡∏¥‡∏ß‡∏≤</span>
            </div>
            <div class="sample-item" data-name="‡∏£‡∏≤‡∏ï‡∏£‡∏µ">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Ratree" alt="Ratree">
                <span>‡∏£‡∏≤‡∏ï‡∏£‡∏µ</span>
            </div>
            <div class="sample-item" data-name="‡∏°‡∏≤‡∏•‡∏µ">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Malee" alt="Malee">
                <span>‡∏°‡∏≤‡∏•‡∏µ</span>
            </div>
            <div class="sample-item" data-name="‡∏ß‡∏≤‡∏¢‡∏∏">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Wayu" alt="Wayu">
                <span>‡∏ß‡∏≤‡∏¢‡∏∏</span>
            </div>
        </div>
    </div>
</div>

{{if .Error}}
    <div class="text-center text-danger mt-3" style="background: #ffebee; padding: 10px; border-radius: 5px;">
        ‚ö†Ô∏è {{.Error}}
    </div>
{{end}}

{{if .Result}}
    <div class="summary-box">
        <div class="summary-row">
            <div class="score-panel">
                <div class="score-item">
                    <div class="score-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</div>
                    <div class="score-value-big {{if lt .Result.TotalScore 0}}bg-bad{{else}}bg-good{{end}}"
                         id="totalScore" data-target="{{.Result.TotalScore}}">0</div>
                </div>
                <div class="divider"></div>
                <div class="score-item">
                    <div class="score-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡∏µ</div>
                    <div class="score-value-small val-good">+<span id="goodScore" data-target="{{.Result.GoodScore}}">0</span></div>
                </div>
                <div class="score-item">
                    <div class="score-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡πâ‡∏≤‡∏¢</div>
                    <div class="score-value-small val-bad"><span id="badScore" data-target="{{.Result.BadScore}}">0</span></div>
                </div>
            </div>

            <div class="galaxy-wrapper">
                <div class="solar-system">
                    <div class="orbit-ring ring-middle">
                        {{range $i, $el := .Result.ShaPairs}}
                            {{if lt $i 5}}
                                <div class="planet-wrapper pos-mid-{{$i}}">
                                    <div class="mini-star {{if .Meaning}}type-{{.Meaning.PairType}}{{else}}star-sha{{end}} c-spin-middle"
                                         title="‡∏û‡∏•‡∏±‡∏á‡πÄ‡∏á‡∏≤: {{.Pair}}">
                                        {{.Pair}}
                                    </div>
                                </div>
                            {{end}}
                        {{end}}
                    </div>
                    <div class="orbit-ring ring-outer">
                        {{range $i, $el := .Result.SatPairs}}
                            {{if lt $i 6}}
                                <div class="planet-wrapper pos-out-{{$i}}">
                                    <div class="mini-star {{if .Meaning}}type-{{.Meaning.PairType}}{{else}}star-sat{{end}} c-spin-outer"
                                         title="‡πÄ‡∏•‡∏Ç‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå: {{.Pair}}">
                                        {{.Pair}}
                                    </div>
                                </div>
                            {{end}}
                        {{end}}
                    </div>
                    <div class="score-circle {{if lt .Result.TotalScore 0}}sun-bad{{else}}sun-good{{end}}">
                        <span id="sunNameDisplay">{{.Result.Name}}</span>
                    </div>
                </div>
            </div>

            <div class="right-column">
                <div class="kakis-box">
                    {{if .Result.HasKakis}}
                        <div style="color: #555; font-size: 0.9rem; background: rgba(255,255,255,0.9); padding: 8px 15px; border-radius: 20px; display: inline-block; border: 1px solid #ef9a9a; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                            <span style="color: #d32f2f;">‚óè</span> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏≤‡∏Å‡∏è<span style="color: #d32f2f; font-weight: bold;">‡∏™‡∏µ‡πÅ‡∏î‡∏á</span>‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏•‡∏Å‡∏¥‡∏ì‡∏µ
                        </div>
                    {{else}}
                        <div class="speech-bubble-success">
                            üèÜ ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏•‡∏Å‡∏¥‡∏ì‡∏µ
                        </div>
                    {{end}}
                </div>
                <div class="action-frame">
                    <div class="action-title" style="margin-bottom:10px;">‡∏î‡∏π‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</div>
                    <a href="#sat-section" class="btn-action btn-sat">
                        <span style="font-size: 1.2rem;">üßÆ</span> ‡πÄ‡∏•‡∏Ç‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå
                    </a>
                    <a href="#sha-section" class="btn-action btn-lang">
                        <span style="font-size: 1.2rem;">üìú</span> ‡∏†‡∏≤‡∏©‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå
                    </a>
                    <div class="action-desc">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2 class="header-line">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢: {{.Result.Name}}</h2>
        <div class="result-container">
            <div class="result-col" id="sat-section">
                <h3 style="color: #0277bd;">üßÆ ‡πÄ‡∏•‡∏Ç‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</h3>
                <p>‡∏ú‡∏•‡∏£‡∏ß‡∏°: <strong>{{.Result.SatSum}}</strong></p>
                {{range .Result.SatPairs}}
                    <div class="pair-card {{if .Meaning}}type-{{.Meaning.PairType}}{{end}}">
                        <div style="display: flex; align-items: flex-start;">
                            <div style="margin-right: 15px; text-align: center; min-width: 50px;">
                                <span class="pair-number">{{.Pair}}</span>
                                {{if .Meaning}}<br><span style="font-size: 0.8rem; padding: 2px 6px; background: #eee; border-radius: 4px; color: #666;">{{.Meaning.PairType}}</span>{{end}}
                            </div>
                            <div>
                                {{if .Meaning}}
                                    <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 5px;">{{.Meaning.MiracleDesc}}</div>
                                    <small style="color: #666; display: block; margin-bottom: 8px;">{{.Meaning.MiracleDetail}}</small>
                                    <span class="badge" style="background: rgba(0,0,0,0.05); color: #333; font-weight: bold;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: {{.Meaning.PairPoint}}</span>
                                {{else}}
                                    <span style="color: #999;">- ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢ -</span>
                                {{end}}
                            </div>
                        </div>
                    </div>
                {{end}}
            </div>
            <div class="result-col" id="sha-section">
                <h3 style="color: #7b1fa2;">üåë ‡∏û‡∏•‡∏±‡∏á‡πÄ‡∏á‡∏≤</h3>
                <p>‡∏ú‡∏•‡∏£‡∏ß‡∏°: <strong>{{.Result.ShaSum}}</strong></p>
                {{range .Result.ShaPairs}}
                    <div class="pair-card {{if .Meaning}}type-{{.Meaning.PairType}}{{end}}">
                        <div style="display: flex; align-items: flex-start;">
                            <div style="margin-right: 15px; text-align: center; min-width: 50px;">
                                <span class="pair-number">{{.Pair}}</span>
                                {{if .Meaning}}<br><span style="font-size: 0.8rem; padding: 2px 6px; background: #eee; border-radius: 4px; color: #666;">{{.Meaning.PairType}}</span>{{end}}
                            </div>
                            <div>
                                {{if .Meaning}}
                                    <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 5px;">{{.Meaning.MiracleDesc}}</div>
                                    <small style="color: #666; display: block; margin-bottom: 8px;">{{.Meaning.MiracleDetail}}</small>
                                    <span class="badge" style="background: rgba(0,0,0,0.05); color: #333; font-weight: bold;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: {{.Meaning.PairPoint}}</span>
                                {{else}}
                                    <span style="color: #999;">- ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢ -</span>
                                {{end}}
                            </div>
                        </div>
                    </div>
                {{end}}
            </div>
        </div>
    </div>
{{end}}

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const counters = [
            document.getElementById('totalScore'),
            document.getElementById('goodScore'),
            document.getElementById('badScore')
        ];

        counters.forEach(counter => {
            if (!counter) return;
            const target = parseInt(counter.getAttribute('data-target'), 10) || 0;
            const duration = 2000;
            const start = 0;
            const startTime = performance.now();

            function updateCount(currentTime) {
                const elapsedTime = currentTime - startTime;
                const progress = Math.min(elapsedTime / duration, 1);
                const easeProgress = (progress === 1) ? 1 : 1 - Math.pow(2, -10 * progress);
                const current = Math.floor(easeProgress * (target - start) + start);
                counter.innerText = current;
                if (progress < 1) requestAnimationFrame(updateCount);
                else counter.innerText = target;
            }
            requestAnimationFrame(updateCount);
        });

        const nameInput = document.getElementById('nameInput');
        const clearBtn = document.getElementById('clearInputBtn');
        const analysisForm = document.getElementById('analysisForm');
        let debounceTimer;

        function triggerSubmit() {
            if (nameInput.value.trim().length > 0) {
                analysisForm.submit();
            }
        }

        if (nameInput && clearBtn) {
            const updateBtnState = () => {
                clearBtn.style.display = nameInput.value.length > 0 ? 'block' : 'none';
            };

            nameInput.addEventListener('keyup', function() {
                let val = this.value;
                val = val.replace(/[^a-zA-Z\u0E00-\u0E7F\s]/g, '');
                val = val.replace(/\s{2,}/g, ' ');
                if (this.value !== val) this.value = val;

                updateBtnState();

                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    triggerSubmit();
                }, 500);
            });

            clearBtn.addEventListener('click', () => {
                nameInput.value = '';
                updateBtnState();
                nameInput.focus();
            });
            updateBtnState();
        }

        const avatars = document.querySelectorAll('.sample-item');
        avatars.forEach(item => {
            item.addEventListener('click', () => {
                const name = item.getAttribute('data-name');
                if(nameInput) {
                    nameInput.value = name;
                    triggerSubmit();
                }
            });
        });

        const fullName = "{{.Result.Name}}";
        const badChars = [{{range .Result.KakisFound}}"{{.}}",{{end}}];
        function highlightText(elementId) {
            const el = document.getElementById(elementId);
            if (!el) return;
            let styledName = "";
            for (let char of fullName) {
                if (badChars.includes(char)) {
                    styledName += `<span style="color: #d32f2f; font-weight: 800; font-size: 1.2em; margin: 0 1px; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">${char}</span>`;
                } else {
                    styledName += `<span>${char}</span>`;
                }
            }
            el.innerHTML = styledName;
        }
        highlightText('sunNameDisplay');
    });
</script>